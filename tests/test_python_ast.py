import ast
import re
import textwrap

from regexploit.python_node_visitor import PythonNodeVisitor, PythonParsedRegex


def patterns_from_code(code: str):
    pnv = PythonNodeVisitor()
    code = textwrap.dedent(code)
    pnv.visit(ast.parse(code))
    return pnv.patterns


def test_basic():
    code = """
    MY_RE = "abc+d+"
    def x():
        '''Just*a*docstring*'''
        a = "nostarsorpluses"
        b = "(" + re.sub("aregex", "*****", "notaregex", flags=re.A) + ")"
        return re.compile(b"x*y*z", re.X | re.MULTILINE)
    """
    patterns = patterns_from_code(code)
    assert len(patterns) == 3
    assert patterns[0] == PythonParsedRegex(2, "abc+d+", 0, False)
    assert patterns[1] == PythonParsedRegex(6, "aregex", re.A, True)
    assert patterns[2] == PythonParsedRegex(7, "x*y*z", re.X | re.MULTILINE, True)
