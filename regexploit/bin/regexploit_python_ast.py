#!/usr/bin/env python
import argparse
import ast
import json
import os.path
import re
import subprocess
import sys
import traceback
import warnings

from glob import iglob

from regexploit.ast.sre import SreOpParser
from regexploit.python_node_visitor import PythonNodeVisitor
from regexploit.redos import find
from regexploit.output.text import TextOutput


def handle_file(filename: str, output: TextOutput):
    with open(filename, "rb") as f:
        code = f.read()
    try:
        code_ast = ast.parse(code)
        pnv = PythonNodeVisitor()
        pnv.visit(code_ast)
    except RecursionError:
        print(f"RecursionError parsing AST for {filename}")
        return
    except SyntaxError:
        print(f"Bad Python3 syntax in {filename}")
        return
    for regex in pnv.patterns:
        first_for_regex = True
        try:
            parsed = SreOpParser().parse_sre(regex.pattern, regex.flags)
        except re.error:
            continue  # We will have many strings which aren't actually regexes
        try:
            output.next()
            for redos in find(parsed):
                if redos.starriness > 2:
                    context = None
                    try:
                        context = code.splitlines()[regex.lineno - 1].decode().strip()
                    except UnicodeDecodeError:
                        pass
                    output.record(
                        redos,
                        regex.pattern,
                        filename=filename,
                        lineno=regex.lineno,
                        context=context,
                    )
        except Exception as e:
            print(
                f"Error finding REDoS: {regex.pattern} from {filename} #{regex.lineno}"
            )
            print(traceback.format_exc())


def main():
    with warnings.catch_warnings():
        # Some weird regexes emit warnings
        warnings.simplefilter("ignore", category=FutureWarning)
        warnings.simplefilter("ignore", category=DeprecationWarning)
        parser = argparse.ArgumentParser(
            description="Parse regexes out of python files and scan them for REDoS"
        )
        parser.add_argument("files", nargs="+", help="Python files")
        parser.add_argument(
            "--glob", action="store_true", help="Glob the input filenames (**/*)"
        )
        args = parser.parse_args()

        files = (
            (fname for fglob in args.files for fname in iglob(fglob, recursive=True))
            if args.glob
            else iter(args.files)
        )
        output = TextOutput()
        for filename in files:
            handle_file(filename, output)
        print(f"Processed {output.regexes} regexes")


if __name__ == "__main__":
    main()
