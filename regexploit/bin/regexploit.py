#!/usr/bin/env python
import fileinput
import sys

from regexploit.ast.sre import SreOpParser
from regexploit.redos import find


def find_redos(pattern: str, flags: int = 0):
    try:
        parsed = SreOpParser.parse_sre(pattern, flags)
    except Exception as e:
        print("Error", e)
        return
    first_for_regex = True
    for redos in find(parsed):
        if redos.starriness > 2:
            if first_for_regex:
                print(f"Vulnerable regex: {pattern}")
                first_for_regex = False
            print(redos)
            print(f"Starriness: {redos.starriness}")
            print(f"Repeated character: {redos.repeated_character}")
            if redos.killer:
                print(f"Final character to cause backtracking: {redos.killer}")
            print(f"Example: {redos.example()}\n")
            yield redos


def main():
    try:
        for line in fileinput.input():
            for _ in find_redos(line.rstrip("\n")):
                pass
    except KeyboardInterrupt:
        pass


if __name__ == "__main__":
    main()
