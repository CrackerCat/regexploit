#!/usr/bin/env python
import fileinput
import logging
import sys

from regexploit.ast.sre import SreOpParser
from regexploit.redos import find
from regexploit.output.text import TextOutput


def find_redos(pattern: str, flags: int, output: TextOutput):
    try:
        parsed = SreOpParser().parse_sre(pattern, flags)
    except Exception as e:
        print("Error", e)
        return
    output.next()
    for redos in find(parsed):
        if redos.starriness > 2:
            output.record(redos, pattern)
            yield redos


def main():
    if "-v" in sys.argv:
        logging.basicConfig(level=logging.INFO)
        sys.argv.remove("-v")
    if "-vv" in sys.argv:
        logging.basicConfig(level=logging.DEBUG)
        sys.argv.remove("-vv")

    isatty = sys.stdin.isatty()
    output = TextOutput()
    try:
        for line in fileinput.input():
            found = False
            for _ in find_redos(line.rstrip("\n"), 0, output):
                found = True
            if isatty and not found:
                print("No REDoS found.")
    except KeyboardInterrupt:
        pass


if __name__ == "__main__":
    main()
