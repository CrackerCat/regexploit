#!/usr/bin/env python
# Check ua_parser for REDoS
# Vulnerable (https://github.com/ua-parser/uap-core/security/advisories/GHSA-cmcx-xhr8-3w9p)
# pip install ua_parser==0.9.0
# Fixed
# pip install ua_parser>=0.10.0
import ua_parser
from ua_parser import user_agent_parser

from regexploit.ast.sre import SreOpParser
from regexploit.redos import find


def main():
    ua_parser_regex = [
        p.pattern
        for p in ua_parser._regexes.USER_AGENT_PARSERS
        + ua_parser._regexes.DEVICE_PARSERS
    ]

    for pattern in ua_parser_regex:
        parsed = SreOpParser.parse_sre(pattern)
        for redos in find(parsed):
            if redos.starriness > 2:
                print(f"Pattern: {pattern}")
                print(redos)
                print(f"Starriness: {redos.starriness}")
                print(f"Repeated character: {redos.repeated_character}")
                if redos.killer:
                    print(f"Final character to cause backtracking: {redos.killer}")
                print(f"Example: {redos.example()}\n")


if __name__ == "__main__":
    main()
