# Load python modules and process regexes which are compiled on import by hooking re.compile
import hook

import importlib
import pkgutil
import sys

from redos import find_redos
from sre import SreOpParser


if __name__ == "__main__":
    for p in pkgutil.walk_packages(sys.path):
        # Importing some modules is disruptive https://xkcd.com/353/
        if (
            p.name != "antigravity"
            and not p.name.startswith(
                ("test", "pip", "urllib3", "setuptools", "idlelib")
            )
            and not p.name.endswith("__main__")
            and ".test" not in p.name
        ):
            print(p.name)
            try:
                importlib.import_module(p.name)
                for pattern, flags in hook.get_and_clear_regexes():
                    parsed = SreOpParser.parse_sre(pattern, flags)
                    for redos in find_redos(parsed):
                        if redos.starriness > 2:
                            print(redos, "for", pattern)
                            print(redos.example())
            except Exception as e:
                print("Cannot load", p, e)
